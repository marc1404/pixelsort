<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />

        <title>PixelSort</title>
    </head>

    <body>
        <h1>
            PixelSort
        </h1>

        <hr>

        <h2>
            1. Choose an image
        </h2>

        <input id="file" type="file" />

        <hr>

        <h2>
            2. Preview
        </h2>

        <img id="image" />

        <hr>

        <h2>
            3. Final Image
        </h2>
        
        <canvas id="canvas"></canvas>

        <script>
            (function () {
                const file = document.getElementById('file');
                const image = document.getElementById('image');
                const canvas = document.getElementById('canvas');
                image.onload = () => start();
                file.onchange = event => preview(event);

                function preview(event) {
                    const { files } = event.target;
                    const [ file ] = files;
                    const fileReader = new FileReader();
                    fileReader.onload = () => image.src = fileReader.result;

                    fileReader.readAsDataURL(file);
                }

                function start() {
                    const { width, height } = image;
                    canvas.width = width;
                    canvas.height = height;
                    const context = canvas.getContext('2d');

                    context.drawImage(image, 0, 0);

                    const pixels = [];

                    console.info('Collecting pixels...');

                    for (let y = 0; y < height; y++) {
                        for (let x = 0; x < width; x++) {
                            const pixel = context.getImageData(x, y, 1, 1);
                            const [red, green, blue] = pixel.data;
                            const [hue, saturation, lightness] = rgbToHsl(red, green, blue);

                            pixels.push({
                                rgb: { red, green, blue},
                                hsv: { hue, saturation, lightness}
                            });
                        }
                    }

                    console.info('Sorting pixels...');

                    const sortedPixels = pixels.sort((a, b) => {
                        if ((a.hsv.saturation === 0 || b.hsv.saturation === 0) && a.hsv.saturation !== b.hsv.saturation) {
                            return b.hsv.saturation - a.hsv.saturation;
                        }

                        if (a.hsv.hue !== b.hsv.hue) {
                            return a.hsv.hue - b.hsv.hue;
                        }

                        if (a.hsv.saturation !== b.hsv.saturation) {
                            return a.hsv.saturation - b.hsv.saturation;
                        }

                        if (a.hsv.saturation === 0 && b.hsv.saturation === 0 && a.hsv.lightness !== b.hsv.lightness) {
                            return b.hsv.lightness - a.hsv.lightness;
                        }

                        return a.hsv.hue - b.hsv.hue;
                    });

                    console.info('Drawing sorted pixels...');

                    let index = 0;

                    for (let y = 0; y < height; y++) {
                        for (let x = 0; x < width; x++) {
                            const pixel = sortedPixels[index++];
                            const { red, green, blue } = pixel.rgb;
                            context.fillStyle = `rgba(${red}, ${green}, ${blue}, 255)`;

                            context.fillRect(x, y, 1, 1);
                        }
                    }
                }

                /**
                * Converts an RGB color value to HSL. Conversion formula
                * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
                * Assumes r, g, and b are contained in the set [0, 255] and
                * returns h, s, and l in the set [0, 1].
                *
                * @param   Number  r       The red color value
                * @param   Number  g       The green color value
                * @param   Number  b       The blue color value
                * @return  Array           The HSL representation
                */
                function rgbToHsl(r, g, b) {
                    r /= 255, g /= 255, b /= 255;

                    var max = Math.max(r, g, b), min = Math.min(r, g, b);
                    var h, s, l = (max + min) / 2;

                    if (max == min) {
                        h = s = 0; // achromatic
                    } else {
                        var d = max - min;
                        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

                        switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                        }

                        h /= 6;
                    }

                    return [ h, s, l ];
                }
            })();
        </script>
    </body>
</html>